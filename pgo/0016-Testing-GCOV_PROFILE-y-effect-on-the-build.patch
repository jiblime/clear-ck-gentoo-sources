From 07a4ade1ba77a56bcd649c647605131ebfd3fcbf Mon Sep 17 00:00:00 2001
From: Jarmo Tiitto <jarmo.tiitto@gmail.com>
Date: Sun, 27 May 2018 02:28:21 +0300
Subject: [PATCH 16/21] Testing "GCOV_PROFILE := y" effect on the build.
 Enabled it for most parts of the kernel.

---
 arch/x86/entry/Makefile        | 2 +-
 arch/x86/events/Makefile       | 1 +
 arch/x86/events/intel/Makefile | 1 +
 arch/x86/kvm/Makefile          | 2 +-
 arch/x86/mm/Makefile           | 3 +++
 block/Makefile                 | 2 +-
 crypto/Makefile                | 2 +-
 drivers/Makefile               | 2 +-
 fs/Makefile                    | 2 +-
 ipc/Makefile                   | 2 +-
 kernel/Makefile                | 2 +-
 lib/Makefile                   | 1 +
 mm/Makefile                    | 1 +
 net/Makefile                   | 2 +-
 sound/Makefile                 | 2 +-
 virt/Makefile                  | 1 +
 16 files changed, 18 insertions(+), 10 deletions(-)

diff --git a/arch/x86/entry/Makefile b/arch/x86/entry/Makefile
index 06fc70cf5433..7f98eb879572 100644
--- a/arch/x86/entry/Makefile
+++ b/arch/x86/entry/Makefile
@@ -2,7 +2,7 @@
 #
 # Makefile for the x86 low level entry code
 #
-
+GCOV_PROFILE := y
 OBJECT_FILES_NON_STANDARD_entry_64_compat.o := y
 
 CFLAGS_syscall_64.o		+= $(call cc-option,-Wno-override-init,)
diff --git a/arch/x86/events/Makefile b/arch/x86/events/Makefile
index b8ccdb5c9244..3dccb22133cd 100644
--- a/arch/x86/events/Makefile
+++ b/arch/x86/events/Makefile
@@ -1,3 +1,4 @@
+GCOV_PROFILE := y
 obj-y					+= core.o
 obj-y					+= amd/
 obj-$(CONFIG_X86_LOCAL_APIC)            += msr.o
diff --git a/arch/x86/events/intel/Makefile b/arch/x86/events/intel/Makefile
index 3468b0c1dc7c..2974e4dc1f77 100644
--- a/arch/x86/events/intel/Makefile
+++ b/arch/x86/events/intel/Makefile
@@ -1,4 +1,5 @@
 # SPDX-License-Identifier: GPL-2.0
+GCOV_PROFILE := y
 obj-$(CONFIG_CPU_SUP_INTEL)		+= core.o bts.o
 obj-$(CONFIG_CPU_SUP_INTEL)		+= ds.o knc.o
 obj-$(CONFIG_CPU_SUP_INTEL)		+= lbr.o p4.o p6.o pt.o
diff --git a/arch/x86/kvm/Makefile b/arch/x86/kvm/Makefile
index dc4f2fdf5e57..92471cf79e1b 100644
--- a/arch/x86/kvm/Makefile
+++ b/arch/x86/kvm/Makefile
@@ -1,5 +1,5 @@
 # SPDX-License-Identifier: GPL-2.0
-
+GCOV_PROFILE := y
 ccflags-y += -Iarch/x86/kvm
 
 CFLAGS_x86.o := -I.
diff --git a/arch/x86/mm/Makefile b/arch/x86/mm/Makefile
index 2b893a375dfd..dee94010501f 100644
--- a/arch/x86/mm/Makefile
+++ b/arch/x86/mm/Makefile
@@ -2,8 +2,11 @@
 # Kernel does not boot with instrumentation of tlb.c and mem_encrypt*.c
 KCOV_INSTRUMENT_tlb.o			:= n
 KCOV_INSTRUMENT_mem_encrypt.o		:= n
+
+# Do instrument mm stuff.
 GCOV_PROFILE_tlb.o	:= n
 GCOV_PROFILE_mem_encrypt.o	:= n
+GCOV_PROFILE := y
 
 KASAN_SANITIZE_mem_encrypt.o		:= n
 KASAN_SANITIZE_mem_encrypt_identity.o	:= n
diff --git a/block/Makefile b/block/Makefile
index 572b33f32c07..0d440b512d16 100644
--- a/block/Makefile
+++ b/block/Makefile
@@ -2,7 +2,7 @@
 #
 # Makefile for the kernel block layer
 #
-
+GCOV_PROFILE := y
 obj-$(CONFIG_BLOCK) := bio.o elevator.o blk-core.o blk-tag.o blk-sysfs.o \
 			blk-flush.o blk-settings.o blk-ioc.o blk-map.o \
 			blk-exec.o blk-merge.o blk-softirq.o blk-timeout.o \
diff --git a/crypto/Makefile b/crypto/Makefile
index 4a08b30e5d7a..558a184ea4cc 100644
--- a/crypto/Makefile
+++ b/crypto/Makefile
@@ -2,7 +2,7 @@
 #
 # Cryptographic API
 #
-
+GCOV_PROFILE := y
 obj-$(CONFIG_CRYPTO) += crypto.o
 crypto-y := api.o cipher.o compress.o memneq.o
 
diff --git a/drivers/Makefile b/drivers/Makefile
index 578f469f72fb..3bd0491ef41c 100644
--- a/drivers/Makefile
+++ b/drivers/Makefile
@@ -5,7 +5,7 @@
 # 15 Sep 2000, Christoph Hellwig <hch@infradead.org>
 # Rewritten to use lists instead of if-statements.
 #
-
+GCOV_PROFILE := y
 obj-y				+= irqchip/
 obj-y				+= bus/
 
diff --git a/fs/Makefile b/fs/Makefile
index 293733f61594..34d628b96b38 100644
--- a/fs/Makefile
+++ b/fs/Makefile
@@ -5,7 +5,7 @@
 # 14 Sep 2000, Christoph Hellwig <hch@infradead.org>
 # Rewritten to use lists instead of if-statements.
 # 
-
+GCOV_PROFILE := y
 obj-y :=	open.o read_write.o file_table.o super.o \
 		char_dev.o stat.o exec.o pipe.o namei.o fcntl.o \
 		ioctl.o readdir.o select.o dcache.o inode.o \
diff --git a/ipc/Makefile b/ipc/Makefile
index c2558c430f51..f4151d0d951e 100644
--- a/ipc/Makefile
+++ b/ipc/Makefile
@@ -2,7 +2,7 @@
 #
 # Makefile for the linux ipc.
 #
-
+GCOV_PROFILE := y
 obj-$(CONFIG_SYSVIPC_COMPAT) += compat.o
 obj-$(CONFIG_SYSVIPC) += util.o msgutil.o msg.o sem.o shm.o syscall.o
 obj-$(CONFIG_SYSVIPC_SYSCTL) += ipc_sysctl.o
diff --git a/kernel/Makefile b/kernel/Makefile
index 9910214f7490..e6efe3103a19 100644
--- a/kernel/Makefile
+++ b/kernel/Makefile
@@ -19,7 +19,7 @@ ifdef CONFIG_FUNCTION_TRACER
 # Do not trace internal ftrace files
 CFLAGS_REMOVE_irq_work.o = $(CC_FLAGS_FTRACE)
 endif
-
+GCOV_PROFILE := y
 # Prevents flicker of uninteresting __do_softirq()/__local_bh_disable_ip()
 # in coverage traces.
 KCOV_INSTRUMENT_softirq.o := n
diff --git a/lib/Makefile b/lib/Makefile
index 1d334c5d1301..ba6c0a77620e 100644
--- a/lib/Makefile
+++ b/lib/Makefile
@@ -11,6 +11,7 @@ endif
 # These files are disabled because they produce lots of non-interesting and/or
 # flaky coverage that is not a function of syscall inputs. For example,
 # rbtree can be global and individual rotations don't correlate with inputs.
+GCOV_PROFILE := y
 KCOV_INSTRUMENT_string.o := n
 GCOV_PROFILE_string.o := n
 KCOV_INSTRUMENT_rbtree.o := n
diff --git a/mm/Makefile b/mm/Makefile
index 26ef77a3883b..0aaa50547a33 100644
--- a/mm/Makefile
+++ b/mm/Makefile
@@ -20,6 +20,7 @@ KCOV_INSTRUMENT_kmemleak.o := n
 KCOV_INSTRUMENT_memcontrol.o := n
 KCOV_INSTRUMENT_mmzone.o := n
 KCOV_INSTRUMENT_vmstat.o := n
+GCOV_PROFILE := y
 
 mmu-y			:= nommu.o
 mmu-$(CONFIG_MMU)	:= gup.o highmem.o memory.o mincore.o \
diff --git a/net/Makefile b/net/Makefile
index bdaf53925acd..d8649343be81 100644
--- a/net/Makefile
+++ b/net/Makefile
@@ -5,7 +5,7 @@
 # 2 Sep 2000, Christoph Hellwig <hch@infradead.org>
 # Rewritten to use lists instead of if-statements.
 #
-
+GCOV_PROFILE := y
 obj-$(CONFIG_NET)		:= socket.o core/
 
 tmp-$(CONFIG_COMPAT) 		:= compat.o
diff --git a/sound/Makefile b/sound/Makefile
index 797ecdcd35e2..27276d1fcdae 100644
--- a/sound/Makefile
+++ b/sound/Makefile
@@ -1,7 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0
 # Makefile for the Linux sound card driver
 #
-
+GCOV_PROFILE := y
 obj-$(CONFIG_SOUND) += soundcore.o
 obj-$(CONFIG_DMASOUND) += oss/dmasound/
 obj-$(CONFIG_SND) += core/ i2c/ drivers/ isa/ pci/ ppc/ arm/ sh/ synth/ usb/ \
diff --git a/virt/Makefile b/virt/Makefile
index be783472ac81..771505393aa5 100644
--- a/virt/Makefile
+++ b/virt/Makefile
@@ -1 +1,2 @@
+GCOV_PROFILE := y
 obj-y	+= lib/
-- 
2.19.2

