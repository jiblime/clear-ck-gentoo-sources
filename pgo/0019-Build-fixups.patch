From dff7fbd7f6337751d99f4db88e4a0f0027839666 Mon Sep 17 00:00:00 2001
From: Jarmo Tiitto <jarmo.tiitto@gmail.com>
Date: Sat, 2 Jun 2018 23:59:47 +0300
Subject: [PATCH 19/21] Build fixups.

---
 scripts/kgcov/calcsum-4.9.cpp |  2 +-
 scripts/kgcov/genPGOKernel    | 25 +++++++++++++------------
 scripts/kgcov/mergegcov.sh    |  9 +++++++--
 3 files changed, 21 insertions(+), 15 deletions(-)

diff --git a/scripts/kgcov/calcsum-4.9.cpp b/scripts/kgcov/calcsum-4.9.cpp
index cfacb0984bbb..68233e5b325c 100644
--- a/scripts/kgcov/calcsum-4.9.cpp
+++ b/scripts/kgcov/calcsum-4.9.cpp
@@ -170,7 +170,7 @@ int write_file(const vector<char> in, const char *filename)
 	// or picked from the gcc error message.
 	// I have not yet figured out where kgcov registers the
 	// GCC version or how to change it automatically per build.
-	unsigned int gcov_version = 1094136362;
+	unsigned int gcov_version = 1094136618;
 	fwrite(in.data(), 1, 4, fp);
 	fwrite(&gcov_version, 1, 4, fp);
 	fwrite(in.data()+8, 1, 4, fp);
diff --git a/scripts/kgcov/genPGOKernel b/scripts/kgcov/genPGOKernel
index 1bdc92cae4ca..f76c7fd8773a 100755
--- a/scripts/kgcov/genPGOKernel
+++ b/scripts/kgcov/genPGOKernel
@@ -22,19 +22,20 @@ cleanup() {
 }
 trap cleanup SIGINT SIGHUP SIGTERM
 
-echo 'Checking profile data..'
-if [ ! -f profile.tar.gz ]; then
-    echo "Missing profile.tar.gz GCDA data!"
-    die "It must be created with `gather.sh profile.tar.gz` on the instrumented system"
-fi
-
-if [ ! -f gcnoprofile.tar.gz ]; then
-    echo "Missing gcnoprofile.tar.gz GCNO data!"
-    die "It should be created by `gathergcno.sh gcnoprofile.tar.gz` after successful buildGCOVKernel run"
-fi
-echo 'Extracting profile data..'
-CHECKPROF=/tmp/kernelPGOdump/sys/kernel/debug/gcov/tmp/kernelsrc/
+echo 'Configuring profile data..'
+CHECKPROF=/tmp/kernelPGOdump/sys/kernel/debug/gcov/tmp/kernelsrc
 if [ ! -f $CHECKPROF/mm/.tmp_mmap.gcda ]; then
+    echo 'Checking profile data..'
+    if [ ! -f profile.tar.gz ]; then
+        echo "Missing profile.tar.gz GCDA data!"
+        die "It must be created with `gather.sh profile.tar.gz` on the instrumented system"
+    fi
+
+    if [ ! -f gcnoprofile.tar.gz ]; then
+        echo "Missing gcnoprofile.tar.gz GCNO data!"
+        die "It should be created by `gathergcno.sh gcnoprofile.tar.gz` after successful buildGCOVKernel run"
+    fi
+
     rm -fr /tmp/kernelPGOdump
     mkdir /tmp/kernelPGOdump
 
diff --git a/scripts/kgcov/mergegcov.sh b/scripts/kgcov/mergegcov.sh
index 46add039c830..b3d50aa58730 100755
--- a/scripts/kgcov/mergegcov.sh
+++ b/scripts/kgcov/mergegcov.sh
@@ -5,6 +5,11 @@
 # Counters are then accumulated into /tmp/kernelPGOdump dir
 KGCCVER=/opt/kgcc-7.3/bin
 
+if [[ ! -f ./scripts/kgcov/calcsum  ]]; then
+    echo "Compiling calcsum-4.9 for post processing the profile data.."
+    gcc gcc -O2 /scripts/kgcov/calcsum-4.9.cpp -o ./scripts/kgcov/calcsum -lstdc++
+fi
+
 NUM=1
 for gcdapkg in $@; do
 	mkdir -p /tmp/kernelPGOdump${NUM}
@@ -15,7 +20,7 @@ for gcdapkg in $@; do
     fi
     echo "Postprocesing GCOV data set ${NUM} with calcsum.."
     find /tmp/kernelPGOdump${NUM} -name '*.gcda' > list.txt
-    ./calcsum list.txt >/dev/null 2>&1
+    ./scripts/kgcov/calcsum list.txt >/dev/null 2>&1
     rm -f list.txt
     
     echo "Postprocesing GCOV data set ${NUM} with kgcov-tool.."
@@ -41,5 +46,5 @@ fi
 echo 'Discaring arch/x86/ profile data...'
 #rm -rf /tmp/kernelPGOdump/sys/kernel/debug/gcov/tmp/kernelPGO/arch/x86
 echo 'Adjusting profile data file names..'
-find /tmp/kernelPGOdump/ -name '*.gcda' -print0 | xargs -0 -n1 -P0 ./rename.sh
+find /tmp/kernelPGOdump/ -name '*.gcda' -print0 | xargs -0 -n1 -P0 ./scripts/kgcov/rename.sh
     
\ No newline at end of file
-- 
2.19.2

